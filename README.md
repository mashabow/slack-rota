# Rota

æ—¥ã€…ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãŠçŸ¥ã‚‰ã›ã™ã‚‹ Slack ã‚¢ãƒ—ãƒª

<img src="assets/post-1.png" alt="ãŠçŸ¥ã‚‰ã›ã®ä¾‹" width="668">

## ä½¿ã„æ–¹

### ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ

ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãŠçŸ¥ã‚‰ã›ã—ãŸã„ãƒãƒ£ãƒ³ãƒãƒ«ã§ã€`/rota` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

<img src="assets/command.png" alt="/rota ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹" width="643">

ã™ã‚‹ã¨ã€ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ãã¾ã™ã€‚ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å›ã™ãƒ¡ãƒ³ãƒãƒ¼ã‚„ã€ãŠçŸ¥ã‚‰ã›ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€æ›œæ—¥ãƒ»æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¾ã—ã‚‡ã†ã€‚

<img src="assets/modal-1.png" alt="ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«" width="534">

ãŠçŸ¥ã‚‰ã›æ™‚ã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã™ã‚‹ç¯„å›²ã‚’é¸ã¶ã“ã¨ã‚‚ã§ãã¾ã™ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§éš ã‚Œã¦ã„ã¦å°‘ã€…ã‚ã‹ã‚Šã«ãã„ã§ã™ãŒâ€¦ï¼‰ã€‚

<img src="assets/modal-2.png" alt="ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ä¸‹éƒ¨" width="534">

[ä½œæˆã™ã‚‹] ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Œäº†ã§ã™ã€‚ã€Œãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸï¼ã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

<img src="assets/success.png" alt="ä½œæˆæˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" width="668">

### Rota ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›

æŒ‡å®šã—ãŸæ—¥æ™‚ã«ãªã‚‹ã¨ã€Rota ãŒä»Šæ—¥ã®æ‹…å½“è€…ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚

<img src="assets/post-1.png" alt="ãŠçŸ¥ã‚‰ã›1å›ç›®" width="668">

æŒ‡å®šã—ãŸæ—¥æ™‚ãŒã‚‚ã†ä¸€åº¦æ¥ã‚‹ã¨ã€ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒã²ã¨ã¤é€²ã¿ã€æ¬¡ã®æ‹…å½“è€…ã«ãªã‚Šã¾ã™ã€‚ä»¥é™ã‚‚åŒæ§˜ã§ã™ã€‚

<img src="assets/post-2.png" alt="ãŠçŸ¥ã‚‰ã›2å›ç›®" width="668">

å³ç«¯ã® [â€¦] ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€æ‰‹å‹•ã§ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€²ã‚ãŸã‚Šã€æˆ»ã—ãŸã‚Šã‚‚ã§ãã¾ã™ã€‚ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ç·¨é›†ã‚‚ã€ã“ã“ã‹ã‚‰ã§ãã¾ã™ã€‚

<img src="assets/overflow.png" alt="[â€¦] ãƒ¡ãƒ‹ãƒ¥ãƒ¼" width="212">

### è£œè¶³

- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éƒ¨åˆ†ã«ã¯ [Slack ã® `mrkdwn` ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ](https://api.slack.com/reference/surfaces/formatting#basics)ãŒä½¿ãˆã¾ã™ã€‚ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ä¸Šã§ã¯æ•´å½¢è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ãŒã€å®Ÿéš›ã®ãŠçŸ¥ã‚‰ã›ã§ã¯ãã¡ã‚“ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
- æ¨©é™ä¸Šã€Rota ã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒãƒ£ãƒ³ãƒãƒ«ã®ã¿ã§å‹•ä½œã—ã¾ã™ã€‚ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ã‚„ DM ã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

ã¾ãšã¯ã€ã‚¢ãƒ—ãƒªã‚’å‹•ã‹ã™ãŸã‚ã® Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„ã—ã¾ã™ã€‚

1. [Firebase ã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.firebase.google.com/)ã‹ã‚‰ã€æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ

1. âš™ï¸ > ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®š > å…¨èˆ¬ ã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªã‚½ãƒ¼ã‚¹ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ `asia-northeast1`ï¼ˆæ±äº¬ï¼‰ã«è¨­å®š

1. âš™ï¸ > ä½¿ç”¨é‡ã¨è«‹æ±‚é¡ > è©³ç´°ã¨è¨­å®š ã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã€æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’ Sparkï¼ˆç„¡æ–™ï¼‰ã‹ã‚‰ Blazeï¼ˆå¾“é‡åˆ¶ï¼‰ã«å¤‰æ›´

1. é–‹ç™º > Database ã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã€Cloud Firestore ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ

1. [Firebase CLI](https://firebase.google.com/docs/cli) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

   ```console
   $ npm install -g firebase-tools
   ```

1. ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã€é©å½“ãªã‚¨ã‚¤ãƒªã‚¢ã‚¹åã‚’è¨­å®š

   ```console
   $ firebase use --add
   ```

### Slack ã‚¢ãƒ—ãƒªã®ä½œæˆ

1. [Bolt å…¥é–€ã‚¬ã‚¤ãƒ‰](https://slack.dev/bolt-js/ja-jp/tutorial/getting-started) ã®ã€Œ[ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹](https://slack.dev/bolt-js/ja-jp/tutorial/getting-started#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B)ã€ã‚’å‚è€ƒã«ã—ã¦ã€Slack ã‚¢ãƒ—ãƒªã‚’ä½œæˆ

   1. [ã‚¢ãƒ—ãƒªä½œæˆãƒšãƒ¼ã‚¸](https://api.slack.com/apps?new_app=1) ã«ç§»å‹•
   1. é©å½“ãªã‚¢ãƒ—ãƒªåã¨ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥åŠ›ã—ã€ã‚¢ãƒ—ãƒªã‚’ä½œæˆ
   1. Manage Distribution > Share Your App with Other Workspaces ã‚’é–‹ãã€Remove Hard Coded Information ã®ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚ŒãŸã‚‰ [Activate Public Distribution] ã‚’ã‚¯ãƒªãƒƒã‚¯
   1. Scopes > Bot Token Scopes ã« `chat:write`, `chat:write.public`, `commands`, `users:read` ã‚’è¿½åŠ 

### Firebase ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

Slack ã‚¢ãƒ—ãƒªã® Basic Information > App Credentials ã®æƒ…å ±ã‚’ Firebase ã«è¨­å®šã—ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

1. Slack ã‚¢ãƒ—ãƒªã® Client ID, Client Secret, Signing Secret ã‚’ã€Firebase Functions ã® `slack.*` ã«è¨­å®š

   ```console
   $ firebase functions:config:set \
     slack.client_id="012345678.1234567..." \
     slack.client_secret="01234567890abcdef..." \
     slack.signing_secret="01234567890abcdef..."
   ```

1. Firebase Functions ã® `rota.*` ã«ä»»æ„ã®ãƒ©ãƒ³ãƒ€ãƒ å€¤ã‚’è¨­å®š

   ```console
   $ firebase functions:config:set \
     rota.state_secret="state_secret" \
     rota.encryption_secret="encryption_secret"
   ```

1. Firebase ã«ãƒ‡ãƒ—ãƒ­ã‚¤ ğŸš€

   ```console
   $ firebase deploy
   ```

### Slack ã‚¢ãƒ—ãƒªã®è¿½åŠ è¨­å®š

Slack ã‹ã‚‰ Firebase Functions ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

1. ã€Œ[ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®é€ä¿¡ã¨å¿œç­”](https://slack.dev/bolt-js/ja-jp/tutorial/getting-started#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E9%80%81%E4%BF%A1%E3%81%A8%E5%BF%9C%E7%AD%94)ã€ã‚’å‚è€ƒã«ã—ã¦ Interactivity ã‚’æœ‰åŠ¹åŒ–

   1. Interactivity & Shortcuts ã® Interactivity ã‚’ On ã«å¤‰æ›´
   1. Request URL ã« `https://asia-northeast1-<Firebaseã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID>.cloudfunctions.net/slack/events` ã¨å…¥åŠ›
   1. è¨­å®šã‚’ä¿å­˜

1. Slash Commands ã‚’è¨­å®š

   1. Slash Commands ã® [Create New Command] ã‚’ã‚¯ãƒªãƒƒã‚¯
   1. Command ã« `/rota` ã¨å…¥åŠ›
   1. Request URL ã« `https://asia-northeast1-<Firebaseã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID>.cloudfunctions.net/slack/events` ã¨å…¥åŠ›
   1. è¨­å®šã‚’ä¿å­˜

1. Redirect URLs ã‚’è¨­å®š

   1. OAuth & Permissions ã® Redirect URLs ã« `https://asia-northeast1-<Firebaseã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID>.cloudfunctions.net/slack/oauth_redirect` ã¨å…¥åŠ›ã—ã¦ã€[Add] ã‚’ã‚¯ãƒªãƒƒã‚¯
   1. [Save URLs] ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨­å®šã‚’ä¿å­˜

1. Event Subscriptions ã‚’æœ‰åŠ¹åŒ–

   1. Event Subscriptions ã® Enable Events ã‚’ On ã«å¤‰æ›´
   1. Request URL ã« `https://asia-northeast1-<Firebaseã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID>.cloudfunctions.net/slack/events` ã¨å…¥åŠ›
   1. Subscribe to bot events ã« `user_change` ã‚’è¿½åŠ 
   1. è¨­å®šã‚’ä¿å­˜

### ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

`https://asia-northeast1-<Firebaseã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID>.cloudfunctions.net/slack/install` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

### å‹•ä½œç¢ºèª

ä»¥ä¸Šã§å®Œäº†ã§ã™ã€‚é©å½“ãªãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒãƒ£ãƒ³ãƒãƒ«ä¸Šã§ `/rota` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€Rota ãŒå‹•ä½œã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## é–‹ç™º

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å‹•ã‹ã™

[Firebase Emulator](https://firebase.google.com/docs/functions/local-emulator?hl=ja) ã§ Functions ã¨ Firestore ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```console
$ cd functions/
$ firebase functions:config:get > .runtimeconfig.json
$ npm run serve
```

http://localhost:4000 ã§ã€Functions ã®ãƒ­ã‚°ã‚„ Firestore ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`slack` é–¢æ•°ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã€http://localhost:5001/your-project-id/asia-northeast1/slack ã«ãªã‚Šã¾ã™ã€‚

Slack ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹ãŸã‚ã«ã¯ã€[ngrok](https://ngrok.com/) ãªã©ã‚’åˆ©ç”¨ã—ã¦ã€ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å¤–éƒ¨ã«å…¬é–‹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§

```console
$ ngrok http 5001
```

ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€https://12345abcde.ngrok.io ã®ã‚ˆã†ãª URL ã§ã€http://localhost:5001 ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚Slack ã‚¢ãƒ—ãƒªã®ä»¥ä¸‹ã®è¨­å®šã«ã€ngrok ã® URL ã‚’ãã‚Œãã‚ŒæŒ‡å®šã—ã¾ã—ã‚‡ã†ã€‚Firebase ã§å‹•ã‹ã™æœ¬ç•ªç”¨ Slack ã‚¢ãƒ—ãƒªã¨ã¯åˆ¥ã«ã€é–‹ç™ºç”¨ã® Slack ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ãŠãã¨æ¥½ã§ã™ã€‚

- Interactivity & Shortcuts > Interactivity > Request URL
  - `https://12345abcde.ngrok.io/your-project-id/asia-northeast1/slack/events`
- Slash Commands > `/rota` > Request URL
  - `https://12345abcde.ngrok.io/your-project-id/asia-northeast1/slack/events`
- OAuth & Permissions > Redirect URLs
  - `https://12345abcde.ngrok.io/your-project-id/asia-northeast1/slack/oauth_redirect`
- Event Subscriptions > Request URL
  - `https://12345abcde.ngrok.io/your-project-id/asia-northeast1/slack/events`

[Cloud Functions ã‚·ã‚§ãƒ«](https://firebase.google.com/docs/functions/local-shell?hl=ja)ã‚’ä½¿ã†ã¨ã€Firebase Emulator ä¸Šã® `cron` é–¢æ•°ã‚’æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```console
$ npm start
firebase > cron()
'Successfully invoked function.'
```

### ãƒ†ã‚¹ãƒˆ

```console
$ npm run test
```

#### firebase-functions-test ã«ã‚ˆã‚‹ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ

`functions/src/__tests__/index.test.ts` ã¯[ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ](https://firebase.google.com/docs/functions/unit-testing?hl=ja#initializing)ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€Firebase ä¸Šã«ã‚ã‚‹å®Ÿç‰©ã® Firestore ã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆä¸€æ–¹ã€Functions ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ä½œã—ã¾ã™ï¼‰ã€‚ä»¥ä¸‹ã®æ‰‹é †ã§ã€ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚

1. ãƒ†ã‚¹ãƒˆç”¨ã® Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹
1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚’è¿½åŠ ã™ã‚‹
1. âš™ï¸ > ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®š > ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ > Firebase Admin SDK ã‚’è¡¨ç¤ºã—ã€[æ–°ã—ã„ç§˜å¯†éµã®ç”Ÿæˆ] ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
1. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸç§˜å¯†éµãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒãƒ¼ãƒ ã—ã€ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã® `serviceAccountKey.json` ã«é…ç½®ã™ã‚‹
1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID ã‚’ `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã® `TEST_PROJECT_ID` ã«è¨­å®šã™ã‚‹

## License

MIT

## Author

Masaya Nakamura (@mashabow)
